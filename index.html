<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Daily Activity | Premium Activity Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        glass: 'rgba(255, 255, 255, 0.1)',
                        glassBorder: 'rgba(255, 255, 255, 0.2)',
                        accent: '#8b5cf6', // Violet
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles & Animations */
        body {
            /* Premium Gradient Background - Deep Space Theme */
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
            background-attachment: fixed;
            color: #e2e8f0;
            min-height: 100vh;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        
        .glass-input:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: #8b5cf6;
            outline: none;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        /* Card Animation */
        .task-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px -10px rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.4);
        }

        /* Locked State */
        .locked-task {
            opacity: 0.6;
            filter: grayscale(0.8);
            pointer-events: none; /* Disable clicks on buttons inside */
            position: relative;
        }
        
        .locked-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(4px);
            z-index: 10;
            border-radius: 1rem;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        ::-webkit-scrollbar-thumb {
            background: #4c1d95;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6d28d9;
        }
        
        /* Modal Animation */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 300ms, transform 300ms;
        }
        /* --- PERBAIKAN IKON JAM & KALENDER --- */
        /* Mengubah warna ikon bawaan browser menjadi putih agar terlihat di bg gelap */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator:hover,
        input[type="time"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="p-4 md:p-8 overflow-x-hidden">

    <audio id="alarmStart" src="mixkit-start-countdown-927.wav" preload="auto"></audio>
    <audio id="alarmEnd" src="mixkit-orchestra-positive-finish-695.wav" preload="auto"></audio>

    <header class="max-w-7xl mx-auto mb-10 flex flex-col md:flex-row justify-between items-center gap-6">
        
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-tr from-violet-600 to-indigo-600 flex items-center justify-center shadow-lg shadow-violet-500/30">
                <i class="fa-solid fa-layer-group text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-violet-200">Daily Activity</h1>
                <p class="text-sm text-gray-400">Master Your Time, Unlock Your Potential</p>
            </div>
        </div>

        <div class="glass-panel px-8 py-3 rounded-full flex flex-col items-center min-w-[280px]">
            <div id="wib-time" class="text-2xl font-bold font-mono tracking-wider text-white">00:00:00</div>
            <div id="wib-date" class="text-xs uppercase tracking-[0.2em] text-violet-300">MEMUAT WAKTU...</div>
        </div>

        <div class="flex items-center gap-4 w-full md:w-auto">
            <div class="relative w-full md:w-64 group">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-3.5 text-gray-400 group-focus-within:text-violet-400 transition-colors"></i>
                <input type="text" id="searchInput" placeholder="Cari aktivitas..." class="glass-input w-full pl-10 pr-4 py-2.5 rounded-xl text-sm placeholder-gray-500 focus:placeholder-gray-400">
            </div>
            <button onclick="openModal('create')" class="bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 text-white px-6 py-2.5 rounded-xl font-medium shadow-lg shadow-violet-900/40 transition-all hover:scale-105 active:scale-95 flex items-center gap-2 whitespace-nowrap">
                <i class="fa-solid fa-plus"></i> Buat Jadwal
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto">
        <div class="mb-8">
            <div class="flex justify-between text-sm mb-2 text-gray-400">
                <span>Progress Harian</span>
                <span id="progressText">0% Selesai</span>
            </div>
            <div class="h-2 w-full bg-slate-800/50 rounded-full overflow-hidden">
                <div id="progressBar" class="h-full bg-gradient-to-r from-violet-500 to-fuchsia-500 w-0 transition-all duration-1000"></div>
            </div>
        </div>

        <div id="emptyState" class="hidden flex-col items-center justify-center py-20 text-center opacity-70">
            <i class="fa-regular fa-calendar-plus text-6xl text-slate-600 mb-4"></i>
            <h3 class="text-xl font-medium text-slate-300">Belum ada aktivitas</h3>
            <p class="text-slate-500 mt-2">Buat jadwal baru untuk memulai produktivitasmu.</p>
        </div>

        <div id="taskContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
    </main>

    <div id="taskModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity">
        <div class="glass-panel w-full max-w-2xl rounded-2xl p-8 relative transform scale-95 opacity-0 transition-all duration-300" id="modalContent">
            <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                <h2 id="modalTitle" class="text-2xl font-bold text-white">Buat Jadwal Baru</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <form id="taskForm" class="space-y-5">
                <input type="hidden" id="taskId">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <div class="md:col-span-2 space-y-2">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Nama Aktivitas</label>
                        <input type="text" id="taskName" required class="glass-input w-full px-4 py-3 rounded-lg" placeholder="Contoh: Kuliah Algoritma">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Prioritas (1-10)</label>
                        <input type="number" id="taskPriority" min="1" max="10" required class="glass-input w-full px-4 py-3 rounded-lg" placeholder="1">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Deskripsi</label>
                    <textarea id="taskDesc" rows="3" class="glass-input w-full px-4 py-3 rounded-lg" placeholder="Detail aktivitas..."></textarea>
                </div>

                <div class="grid grid-cols-2 gap-5">
                    <div class="space-y-2">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Tanggal Mulai</label>
                        <input type="date" id="taskStartDate" required class="glass-input w-full px-4 py-2 rounded-lg text-sm">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Jam Mulai</label>
                        <input type="time" id="taskStartTime" step="1" required class="glass-input w-full px-4 py-2 rounded-lg text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-5">
                    <div class="space-y-2">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Tanggal Selesai</label>
                        <input type="date" id="taskEndDate" required class="glass-input w-full px-4 py-2 rounded-lg text-sm">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Jam Selesai</label>
                        <input type="time" id="taskEndTime" step="1" required class="glass-input w-full px-4 py-2 rounded-lg text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="space-y-2">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Link Pengerjaan</label>
                        <input type="url" id="taskLink" class="glass-input w-full px-4 py-2 rounded-lg text-sm" placeholder="https://...">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">PIC / Penanggung Jawab</label>
                        <input type="text" id="taskPic" class="glass-input w-full px-4 py-2 rounded-lg text-sm" placeholder="Nama PIC">
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-white/10">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 rounded-lg text-gray-300 hover:bg-white/5 transition-colors">Batal</button>
                    <button type="submit" class="bg-violet-600 hover:bg-violet-700 text-white px-8 py-2 rounded-lg shadow-lg shadow-violet-900/50 transition-all font-medium">Simpan Jadwal</button>
                </div>
            </form>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-xl rounded-2xl p-0 overflow-hidden relative transform scale-95 opacity-0 transition-all duration-300" id="detailContent">
            
            <div class="h-24 bg-gradient-to-r from-violet-900 to-indigo-900 relative">
                <button onclick="closeDetailModal()" class="absolute top-4 right-4 text-white/70 hover:text-white bg-black/20 hover:bg-black/40 rounded-full w-8 h-8 flex items-center justify-center transition-all">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="p-8 -mt-12">
                <div class="flex justify-between items-end mb-4">
                    <div class="bg-black/40 backdrop-blur border border-white/10 rounded-xl p-3 shadow-lg">
                        <span id="detailPriority" class="text-2xl font-bold text-violet-400">#1</span>
                        <span class="text-xs text-gray-400 block uppercase">Prioritas</span>
                    </div>
                    <span id="detailStatus" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-700 text-gray-300 border border-gray-600">PENDING</span>
                </div>

                <h2 id="detailName" class="text-3xl font-bold text-white mb-2 leading-tight">Nama Tugas</h2>
                <div class="flex items-center gap-2 text-sm text-gray-400 mb-6">
                    <i class="fa-regular fa-user"></i> <span id="detailPic">PIC Name</span>
                </div>

                <div class="space-y-4 text-gray-300">
                    <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                        <p id="detailDesc" class="text-sm leading-relaxed">Deskripsi lengkap...</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="block text-xs text-gray-500 uppercase mb-1">Mulai</span>
                            <div class="text-violet-300 font-mono" id="detailStart">dd/mm/yyyy hh:mm:ss</div>
                        </div>
                        <div>
                            <span class="block text-xs text-gray-500 uppercase mb-1">Selesai</span>
                            <div class="text-pink-300 font-mono" id="detailEnd">dd/mm/yyyy hh:mm:ss</div>
                        </div>
                    </div>

                    <div id="detailLinkContainer" class="pt-2 hidden">
                        <a id="detailLink" href="#" target="_blank" class="flex items-center justify-center gap-2 w-full bg-white/10 hover:bg-white/20 border border-white/20 text-white py-2 rounded-lg transition-all">
                            <i class="fa-solid fa-link"></i> Buka Link Pengerjaan
                        </a>
                    </div>
                </div>

                <div class="flex gap-3 mt-8 pt-6 border-t border-white/10">
                    <button id="btnDetailEdit" class="flex-1 bg-indigo-600/80 hover:bg-indigo-600 text-white py-2.5 rounded-xl transition-all">
                        <i class="fa-solid fa-pen-to-square mr-2"></i> Edit
                    </button>
                    <button id="btnDetailDelete" class="flex-1 bg-red-500/20 hover:bg-red-500/40 text-red-300 border border-red-500/30 py-2.5 rounded-xl transition-all">
                        <i class="fa-solid fa-trash mr-2"></i> Hapus
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. STATE & UTILS ---
        let tasks = JSON.parse(localStorage.getItem('chronosTasks')) || [];
        const alarmStart = document.getElementById('alarmStart');
        const alarmEnd = document.getElementById('alarmEnd');

        // Format Date untuk Input
        const formatDateInput = (dateObj) => dateObj.toISOString().split('T')[0];
        
        // Save to LocalStorage
        const saveTasks = () => {
            localStorage.setItem('chronosTasks', JSON.stringify(tasks));
            renderTasks();
        };

        // --- 2. CLOCK & ALARM SYSTEM ---
        const updateClock = () => {
            const now = new Date();
            
            // Format WIB (Indonesia)
            const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Jakarta' };
            const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Asia/Jakarta' };
            
            document.getElementById('wib-date').innerText = new Intl.DateTimeFormat('id-ID', optionsDate).format(now);
            document.getElementById('wib-time').innerText = new Intl.DateTimeFormat('id-ID', optionsTime).format(now).replace(/\./g, ':');

            checkAlarms(now);
        };

        const checkAlarms = (now) => {
            tasks.forEach(task => {
                if (task.status === 'completed') return;

                const start = new Date(`${task.startDate}T${task.startTime}`);
                const end = new Date(`${task.endDate}T${task.endTime}`);
                
                // Cek Start Alarm (presisi detik)
                if (isSameTime(now, start) && !task.notifiedStart) {
                    playAlarm('start', task.name);
                    task.notifiedStart = true;
                    saveTasks(); // Simpan state notifikasi
                }

                // Cek Warning Alarm (misal 5 menit sebelum selesai atau pas selesai)
                // Disini saya set pas selesai sebagai "Warning Finish"
                if (isSameTime(now, end) && !task.notifiedEnd) {
                    playAlarm('end', task.name);
                    task.notifiedEnd = true;
                    saveTasks();
                }
            });
        };

        const isSameTime = (d1, d2) => {
            return d1.getHours() === d2.getHours() && 
                   d1.getMinutes() === d2.getMinutes() && 
                   d1.getSeconds() === d2.getSeconds();
        };

        const playAlarm = (type, taskName) => {
            const audio = type === 'start' ? alarmStart : alarmEnd;
            audio.play().catch(e => console.log("Audio play blocked until interaction"));
            
            Swal.fire({
                title: type === 'start' ? '⏰ Waktunya Mulai!' : '⚠️ Waktu Habis!',
                text: `Aktivitas: ${taskName}`,
                icon: type === 'start' ? 'info' : 'warning',
                background: '#1e1b4b',
                color: '#fff',
                confirmButtonColor: '#8b5cf6'
            });
        };

        setInterval(updateClock, 1000);
        updateClock(); // Init run

        // --- 3. CRUD OPERATIONS ---

        // Generate Random ID
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        // Add / Edit Task Handler
        document.getElementById('taskForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = document.getElementById('taskId').value;
            const isEdit = !!id;

            const taskData = {
                id: isEdit ? id : generateId(),
                name: document.getElementById('taskName').value,
                priority: document.getElementById('taskPriority').value,
                desc: document.getElementById('taskDesc').value,
                startDate: document.getElementById('taskStartDate').value,
                startTime: document.getElementById('taskStartTime').value,
                endDate: document.getElementById('taskEndDate').value,
                endTime: document.getElementById('taskEndTime').value,
                link: document.getElementById('taskLink').value,
                pic: document.getElementById('taskPic').value,
                status: isEdit ? tasks.find(t => t.id === id).status : 'pending', // Maintain status on edit
                notifiedStart: isEdit ? tasks.find(t => t.id === id).notifiedStart : false,
                notifiedEnd: isEdit ? tasks.find(t => t.id === id).notifiedEnd : false,
            };

            if (isEdit) {
                const index = tasks.findIndex(t => t.id === id);
                tasks[index] = taskData;
            } else {
                tasks.push(taskData);
            }

            saveTasks();
            closeModal();
            
            Swal.fire({
                icon: 'success',
                title: isEdit ? 'Diperbarui' : 'Tersimpan',
                text: 'Jadwal aktivitas berhasil diatur',
                background: '#1e1b4b',
                color: '#fff',
                timer: 1500,
                showConfirmButton: false
            });
        });

        // Delete Task
        const deleteTask = (id) => {
            Swal.fire({
                title: 'Hapus Jadwal?',
                text: "Data tidak bisa dikembalikan!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Hapus!',
                background: '#1e1b4b',
                color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    tasks = tasks.filter(t => t.id !== id);
                    saveTasks();
                    closeDetailModal();
                }
            });
        };

        // Duplicate Task
        const duplicateTask = (id, e) => {
            e.stopPropagation(); // Stop clicking the card itself
            const original = tasks.find(t => t.id === id);
            const copy = { ...original, id: generateId(), name: original.name + ' (Copy)', status: 'pending', notifiedStart: false, notifiedEnd: false };
            tasks.push(copy);
            saveTasks();
        };

        // Complete Task (Unlock Logic Trigger)
      // Complete Task (Fixed Logic: Based on Sorted Time)
        const toggleComplete = (id, e) => {
            e.stopPropagation();
            
            // 1. Kita harus mengurutkan data dulu sama persis seperti tampilan di layar (Berdasarkan Waktu)
            // Buat copy array agar urutan asli tidak berantakan
            let sortedTasks = [...tasks].sort((a, b) => {
                const dateA = new Date(`${a.startDate}T${a.startTime}`);
                const dateB = new Date(`${b.startDate}T${b.startTime}`);
                return dateA - dateB;
            });

            // 2. Cari posisi tugas yang diklik di dalam daftar yang SUDAH DIURUTKAN
            const sortedIndex = sortedTasks.findIndex(t => t.id === id);
            
            // 3. Logika Validasi: Cek task sebelumnya di list yang sudah urut waktu
            // Jika bukan task paling pertama (index 0) secara waktu, cek apakah task sebelumnya sudah selesai
            if (sortedIndex > 0) {
                const prevTask = sortedTasks[sortedIndex - 1];
                if (prevTask.status !== 'completed') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Terkunci!',
                        text: 'Selesaikan tugas sebelumnya (berdasarkan urutan waktu) terlebih dahulu.',
                        background: '#1e1b4b',
                        color: '#fff',
                        confirmButtonColor: '#8b5cf6'
                    });
                    return; // Stop, jangan lanjutkan proses
                }
            }

            // 4. Jika lolos validasi, update status di data asli
            const originalIndex = tasks.findIndex(t => t.id === id);
            const task = tasks[originalIndex];
            
            task.status = task.status === 'completed' ? 'pending' : 'completed';
            
            // Efek suara checklist
            if(task.status === 'completed') {
                const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/1114/1114-preview.mp3'); 
                audio.play().catch(()=>{});
            }

            saveTasks();
        };
        // --- 4. RENDERING & LOCK LOGIC ---

        const renderTasks = () => {
            const container = document.getElementById('taskContainer');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            
            // 1. Filter
            let filtered = tasks.filter(t => t.name.toLowerCase().includes(searchVal));

            // 2. Sorting (Tanggal Terdekat di Atas)
            filtered.sort((a, b) => {
                const dateA = new Date(`${a.startDate}T${a.startTime}`);
                const dateB = new Date(`${b.startDate}T${b.startTime}`);
                return dateA - dateB;
            });

            // Update Progress Bar
            const total = filtered.length;
            const completed = filtered.filter(t => t.status === 'completed').length;
            const percent = total === 0 ? 0 : Math.round((completed / total) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').innerText = `${percent}% Selesai`;

            container.innerHTML = '';

            if (filtered.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('emptyState').classList.add('flex');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('flex');
            }

            // 3. Render Loop with Locking Logic
            filtered.forEach((task, index) => {
                // Logika Kunci: Task terkunci jika bukan task pertama DAN task sebelumnya belum completed
                let isLocked = false;
                if (index > 0) {
                    const prevTask = filtered[index - 1];
                    if (prevTask.status !== 'completed') {
                        isLocked = true;
                    }
                }

                // Setup Styles based on Status/Lock
                const isCompleted = task.status === 'completed';
                const statusColor = isCompleted ? 'text-green-400 border-green-500/50' : 'text-gray-400 border-white/10';
                const cardOpacity = isCompleted ? 'opacity-70' : 'opacity-100';
                
                const card = document.createElement('div');
                card.className = `task-card glass-panel rounded-2xl p-6 relative overflow-hidden group ${cardOpacity} ${isLocked ? 'locked-task' : 'cursor-pointer'}`;
                
                // Jika Locked, tambahkan overlay gembok
                let lockOverlay = '';
                if (isLocked) {
                    lockOverlay = `
                        <div class="locked-overlay flex-col gap-2">
                            <i class="fa-solid fa-lock text-3xl text-gray-400"></i>
                            <span class="text-xs text-gray-400 font-medium uppercase tracking-widest">Terkunci</span>
                        </div>
                    `;
                }

                card.innerHTML = `
                    ${lockOverlay}
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-violet-400 mb-1">PRIORITAS ${task.priority}</span>
                            <h3 class="text-xl font-bold text-white line-clamp-1 group-hover:text-violet-200 transition-colors ${isCompleted ? 'line-through decoration-2 decoration-green-500' : ''}">${task.name}</h3>
                        </div>
                        <button onclick="toggleComplete('${task.id}', event)" class="z-20 w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${isCompleted ? 'bg-green-500 border-green-500 text-white' : 'border-gray-500 text-transparent hover:border-violet-400'}">
                            <i class="fa-solid fa-check text-sm"></i>
                        </button>
                    </div>

                    <p class="text-gray-400 text-sm mb-4 line-clamp-2 min-h-[40px]">${task.desc}</p>

                    <div class="grid grid-cols-2 gap-2 text-xs mb-4">
                        <div class="bg-white/5 p-2 rounded-lg border border-white/5">
                            <i class="fa-regular fa-clock text-violet-400 mr-1"></i> Mulai<br>
                            <span class="text-gray-300 font-mono mt-1 block">${task.startTime}</span>
                            <span class="text-gray-500 text-[10px]">${task.startDate}</span>
                        </div>
                        <div class="bg-white/5 p-2 rounded-lg border border-white/5">
                            <i class="fa-solid fa-flag-checkered text-pink-400 mr-1"></i> Selesai<br>
                            <span class="text-gray-300 font-mono mt-1 block">${task.endTime}</span>
                            <span class="text-gray-500 text-[10px]">${task.endDate}</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-4 border-t border-white/10 relative z-20">
                        <div class="flex items-center gap-2">
                            ${task.pic ? `<span class="bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded text-[10px] font-bold uppercase">${task.pic.substring(0,8)}</span>` : ''}
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="duplicateTask('${task.id}', event)" class="text-gray-400 hover:text-white p-1" title="Duplicate"><i class="fa-regular fa-copy"></i></button>
                            <button onclick="deleteTask('${task.id}')" class="text-gray-400 hover:text-red-400 p-1" title="Delete"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;

                // Event Listener untuk Buka Detail (Hanya jika tidak terkunci)
                if (!isLocked) {
                    card.addEventListener('click', (e) => {
                        // Mencegah trigger jika klik tombol action
                        if(e.target.closest('button')) return;
                        openDetail(task);
                    });
                }

                container.appendChild(card);
            });
        };

        // --- 5. MODAL CONTROL ---

        const modal = document.getElementById('taskModal');
        const modalContent = document.getElementById('modalContent');
        const detailModal = document.getElementById('detailModal');
        const detailContent = document.getElementById('detailContent');

        const openModal = (mode, task = null) => {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);

            if (mode === 'edit' && task) {
                document.getElementById('modalTitle').innerText = 'Edit Jadwal';
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskPriority').value = task.priority;
                document.getElementById('taskDesc').value = task.desc;
                document.getElementById('taskStartDate').value = task.startDate;
                document.getElementById('taskStartTime').value = task.startTime;
                document.getElementById('taskEndDate').value = task.endDate;
                document.getElementById('taskEndTime').value = task.endTime;
                document.getElementById('taskLink').value = task.link;
                document.getElementById('taskPic').value = task.pic;
            } else {
                document.getElementById('modalTitle').innerText = 'Buat Jadwal Baru';
                document.getElementById('taskForm').reset();
                document.getElementById('taskId').value = '';
                // Default date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('taskStartDate').value = today;
                document.getElementById('taskEndDate').value = today;
            }
        };

        const closeModal = () => {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };

        // Detail Modal Logic
        const openDetail = (task) => {
            detailModal.classList.remove('hidden');
            setTimeout(() => {
                detailContent.classList.remove('scale-95', 'opacity-0');
                detailContent.classList.add('scale-100', 'opacity-100');
            }, 10);

            // Populate Data
            document.getElementById('detailName').innerText = task.name;
            document.getElementById('detailPriority').innerText = `#${task.priority}`;
            document.getElementById('detailStatus').innerText = task.status === 'completed' ? 'SELESAI' : 'MENUNGGU';
            document.getElementById('detailStatus').className = task.status === 'completed' 
                ? 'px-3 py-1 rounded-full text-xs font-bold bg-green-500/20 text-green-400 border border-green-500/50' 
                : 'px-3 py-1 rounded-full text-xs font-bold bg-yellow-500/20 text-yellow-400 border border-yellow-500/50';
            
            document.getElementById('detailPic').innerText = task.pic || '-';
            document.getElementById('detailDesc').innerText = task.desc || 'Tidak ada deskripsi.';
            document.getElementById('detailStart').innerText = `${task.startDate} ${task.startTime}`;
            document.getElementById('detailEnd').innerText = `${task.endDate} ${task.endTime}`;
            
            const linkBtn = document.getElementById('detailLink');
            const linkContainer = document.getElementById('detailLinkContainer');
            if (task.link) {
                linkContainer.classList.remove('hidden');
                linkBtn.href = task.link;
            } else {
                linkContainer.classList.add('hidden');
            }

            // Bind Actions in Detail View
            document.getElementById('btnDetailEdit').onclick = () => {
                closeDetailModal();
                setTimeout(() => openModal('edit', task), 300);
            };
            document.getElementById('btnDetailDelete').onclick = () => {
                deleteTask(task.id);
            };
        };

        const closeDetailModal = () => {
            detailContent.classList.remove('scale-100', 'opacity-100');
            detailContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                detailModal.classList.add('hidden');
            }, 300);
        };

        // Search Listener
        document.getElementById('searchInput').addEventListener('input', renderTasks);

        // Initial Render
        renderTasks();

    </script>
</body>
</html>